Техническое задание сервиса печати на ККТ Custom 302ФБ.

Общее описание
Сервис или программа запускается при старте Windows.
Сервис отвечает по http порту на запросы, и взаимодействует с ККТ Custom 302ФБ.
Сервис позволит: 
•	печатать чеки на ККТ
•	печатать агентские чеки на ККТ
•	печатать на ККТ X-отчет
•	закрывать смену на ККТ
•	печатать текст с QR кодом и картинками. Параметры картинки ограничиваются техническими возможностями ККТ.
•	сообщать текущий статус ККТ
•	изменять картинки в памяти ККТ.
http запросы к сервису будут приниматься только с ip адресов указанных в настройке и при указании в параметрах запроса token указанного в настройках.

Дополнительные требования: сервис ведет журнал входящих запросов и ответов и ошибок, использовать файл с настройками, работать с описанным в тексте задания файлами шаблонов, журналы разбиваются на по дневные файлы, при превышении указанной в настройках глубине хранения журнала удалять устаревшие файлы журналов.

В файле настроек регулируется: номер порта http, глубина хранения файлов журнала запросов и ответов в днях, глубина хранения файлов ошибок в днях, номер com порта для подключения ккт, скорость обмена com порта, список разрешенных ip адресов, настройка выбора НДС (нет НДС или процента для ИНН агента) , настройка выбора НДС для чека.

Описание http запросов к сервису.

Запрос печати чека прихода на ККТ.
POST /print-check

{
  operationId: 12345, // внутренний идентификтор операций с ККТ
  agent: "no",//no чек простой, yes чек с признаком агента
  inn: "",//ИНН агента
  agentName: "",//Наименование агента
  items:
    [
      {
        itemName: "Попкорн",
        itemCount: 1000,
        itemPrice: 30000,
        itemSum: 30000
      },
      {
        itemName: "Кола",
        itemCount: 1000,
        itemPrice: 6000,
        itemSum: 6000
      },
      {
        itemName: "Жвачка",
        itemCount: 2000,
        itemPrice: 4900,
        itemSum: 9800
      }
    ]
  sum: 45800,
  tax: "patent",//Налогооблажение
  comment: ""
}
Ответ
{
  status: "success", // статус: "success" или "error"
  erros: "string" // при наличии ошибок возвращает текстовую информацию
}

Запрос печати чека возврата прихода на ККТ.
POST /print-check-back

{
  operationId: 12345, // внутренний идентификтор операций с ККТ
  agent: "no",//no чек простой, yes чек с признаком агента
  inn: "",//ИНН агента
  agentName: "",//Наименование агента
  items:
    [
      {
        itemName: "Попкорн",
        itemCount: 1000,
        itemPrice: 30000,
        itemSum: 30000
      },
      {
        itemName: "Кола",
        itemCount: 1000,
        itemPrice: 6000,
        itemSum: 6000
      },
      {
        itemName: "Жвачка",
        itemCount: 2000,
        itemPrice: 4900,
        itemSum: 9800
      }
    ]
  sum: 45800,
  tax: "patent",//Налогооблажение
  comment: ""
}
Ответ
{
  status: "success", // статус: "success" или "error"
  erros: "string" // при наличии ошибок возвращает текстовую информацию
}


Запрос печати слип чека.

POST /print-slip-check { "slip_check": "string" }
Значения для operationType: " slipcheck ".
Построчно распечатывает содержание message.
{
	operationType: "slipcheck",         // тип операции
	message:””
}

Запрос печати текста билета.
{
    operationType: "ticket",           // тип операции
    ticketFormat: "sale.txt",             // имя файла шаблона
    ticket:
        [
            {
                    theather: "Кинотеатр КИНО",
                    legalName: "АО \"Фильм Фильм Фильм\"",
                    ogrn: "1027739050646",
                    inn: "7705353706",
                    legalAddress: "125212, г. Москва, 1-ый Грайвороносовский пр-д, д. 20, с. 36",            // 
                    movie: "Фантастические твари: Преступления Грин-де-Вальда",
                    format: "2D",
                    license: "121025518",
                    age: "12+",
                    datetimeShow: "15.11.2019 17:05",
                    hall: "8",
                    row: 2,
                    place: 3,
                    price: 100000,
                    discount: "",
                    code: "12345678",
                    certificate: "",
                    bonusCard: "",
                    bonusType: "Начисление",
                    saleType: "Безналичные",
                    cashier: "Иванов Иван Иванович",                                                          // имя кассира из настроек киоска
                    datetimeSale: "14.11.2019 16:00"
            },        ]
}
Ответ
{
	status: "success",                // статус: "success" или "error"
	erros: "string"                   // при наличии ошибок возвращает текстовую информацию
}

Запрос закрытия кассовой смены.
GET /close-shift
*Ответ*
{
	status: "success",                // статус: "success" или "error"
	erros: "string"                   // при наличии ошибок возвращает текстовую информацию
}

Запрос печати x-отчета.
GET /report-x

*Ответ*
{
	status: "success",                // статус: "success" или "error"
	erros: "string"                   // при наличии ошибок возвращает текстовую информацию
}

Запрос статуса ККТ
****{
	operationType: "status",           // тип операции
}
*Ответ*
{
	status: "success",                // статус: "success" или "error"
	erros: "string"                   // при наличии ошибок возвращает текстовую информацию
}

Описание формата файлов шаблонов печати билетов.
В шаблоне печати возможно выводить на печать текст, QR код, картинки.
При печати текста билета нужно дать команду начала билета, после команды вывода рамки билета или печати текста или печати картинок или печати QR кода. После того как будет дана команда закрытия билетов. Команды используются по мере приведения их в файле шаблона, сверху вниз. Внутри файлов шаблона может быть несколько “билетов”. 
	В тексте шаблона используются названия полей с содержанием билета. Если в запросе печати будет поле с соответствующим названием, то при подаче команды печати на принтер название поля заменяется на значением поля в запросе.
Формат названия поля в тексте: [название поля]. Пример: [FILM].
Команда начала печати билета.
[OT]

Команда окончания печати билета.
[CT]

Команда печати текстовой строки.
<TL:X,Y><PRINT><SAVETF><SCALEX:[SCALE]><SCALEY:[SCALE]><ROTEATE:[ROTATE]><F:BOLD><F:UNDERLINE><F:COURSIVE><F:SIZE:[SIZE]>Текстовая линия</TL>
Открывается командой <TL:X,Y>.
X- позиция начала строки по горизонтали(целочисленное значение)
Y – позиция начала строки по вертикали(целочисленное значение)
<PRINT> -вставляется после открывающей печать строки команды перед текстом и закрывающей печать строки командой, если команда строку нужно вывести на печать.
<SAVETF> - вставляется после открывающей печать строки команды перед текстом и закрывающей печать строки командой, если команда строку нужно сохранить в файл.
<SCALEX:[SCALE]> - вставляется после открывающей печать строки команды перед текстом и закрывающей печать строки командой, для смены масштаба печати текста по горизонтали(целочисленное значение).
<SCALEY:[SCALE]> - вставляется после открывающей печать строки команды перед текстом и закрывающей печать строки командой, для смены масштаба печати текста по вертикали(целочисленное значение).
<ROTEATE:[ROTATE]> - вставляется после открывающей печать строки команды перед текстом и закрывающей печать строки командой, для поворота текста по часовой стрелке на указанное количество градусов. Возможные значения: 0,90,180, 270.
<F:BOLD>- вставляется после открывающей печать строки команды перед текстом и закрывающей печать строки командой, для печати текста в «жирном» стиле.
<F:COURSIVE>- вставляется после открывающей печать строки команды перед текстом и закрывающей печать строки командой, для печати текста в «наклонном» стиле.
<F:UNDERLINE>- вставляется после открывающей печать строки команды перед текстом и закрывающей печать строки командой, для печати текста в «подчеркнутом» стиле.
<F:SIZE:[SIZE]>- вставляется после открывающей печать строки команды перед текстом и закрывающей печать строки командой, для определения размера шрифта печати текста(целочисленное значение).
</TL> - закрывающая печать строки текста команда. Перед этой командой вставляется текст для печати.

Команда вывода на печать рамки.
<FRAME:[X],[Y],[WIDTH],[HEIGHT]>
X- позиция начала строки по горизонтали(целочисленное значение)
Y – позиция начала строки по вертикали(целочисленное значение)
WIDTH – ширина печати(целочисленное значение)
HEIGHT – высота печати(целочисленное значение)

Команда вывода на печать картинки.
<BITMAP:[X],[Y] ,[HEIGHT],[WEIGHT],[BITMAP INDEX]>
X- позиция начала строки по горизонтали(целочисленное значение)
Y – позиция начала строки по вертикали(целочисленное значение)
WIDTH – ширина печати(целочисленное значение)
HEIGHT – высота печати(целочисленное значение)

Команда вывода на печать QR кода.
<QR:[X],[Y],[HEIGHT],[WEIGHT],WITHTEXT>QR CODE</QR>
X- позиция начала строки по горизонтали(целочисленное значение)
Y – позиция начала строки по вертикали(целочисленное значение)
WIDTH – ширина печати(целочисленное значение)
HEIGHT – высота печати(целочисленное значение)
WITHTEXT – Наличие параметра сообщает о необходимости напечатать код QR под картинкой QR кода

Пример шаблона печати:
[OT]
<FRAME:10,10,290,390>
<TL:20,20><PRINT><SAVETF><SCALEX:1><SCALEY:2><ROTEATE:0><F:BOLD><F:UNDERLINE><F:COURSIVE><F:SIZE:1>Текстовая линия</TL>	
<BITMAP:20,40 ,100,100,1>
<QR:20,160,100,100,WITHTEXT>1323sadfasda</QR>
 [CT]
